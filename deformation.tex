\documentclass[a4paper,11pt]{article}

\author{Sebastian Pancratz, Jan Tuitman}
\title{Practical improvements to the deformation method for counting points on smooth projective hypersurfaces}

% Geometry and page layout %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage[hmargin=3.2cm,vmargin=3.2cm,a4paper,centering,twoside]{geometry}

% Other packages %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage[T1]{fontenc}
\usepackage{ae,aecompl}
\usepackage{verbatim}
\usepackage{ifpdf}

% hyperref %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{hyperref}
\hypersetup{
    colorlinks=false,   % false: boxed links; true: colored links
    citecolor=green,    % color of links to bibliography
    filecolor=magenta,  % color of file links
    linkcolor=red,      % color of internal links
    urlcolor=blue       % color of external links
}

\makeatletter
\newcommand\org@hypertarget{}
\let\org@hypertarget\hypertarget
\renewcommand\hypertarget[2]{%
    \Hy@raisedlink{\org@hypertarget{#1}{}}#2%
} 
\makeatother

\ifpdf
    \hypersetup{
        pdftitle={Deformation method},
        pdfauthor={Sebastian Pancratz, Jan Tuitman},
        pdfsubject={Computational Number Theory},
        bookmarks=true,
        bookmarksnumbered=true,
        unicode=true,
        pdfstartview={FitH},
        pdfpagemode={UseOutlines}
    }
\fi

% algorithmic %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage[section]{algorithm}
\usepackage[noend]{algpseudocode}

\renewcommand{\algorithmicrequire}{\textbf{Input:}}
\renewcommand{\algorithmicensure}{\textbf{Output:}}

% natbib %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{natbib}

\bibpunct{[}{]}{,}{n}{}{}

% url %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{url}

\makeatletter
\def\url@leostyle{%
  \@ifundefined{selectfont}{\def\UrlFont{\sf}}{\def\UrlFont{\small\ttfamily}}}
\makeatother
\urlstyle{leostyle}

% Enumeration %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{paralist}

\setlength{\pltopsep}{0.24em}
\setlength{\plpartopsep}{0em}
\setlength{\plitemsep}{0.24em}

% This should do what we want
%   \setdefaultenum{(i)}{(a)}{1.}{A}
% but it does not work for references, dropping the parentheses.  The following
% hack does work.

\renewcommand{\theenumi}{(\roman{enumi})}
\renewcommand{\theenumii}{(\alph{enumii})}
\renewcommand{\theenumiii}{\arabic{enumiii}.}
\renewcommand{\theenumiv}{\Alph{enumiv}}

\renewcommand{\labelenumi}{\theenumi}
\renewcommand{\labelenumii}{\theenumii}
\renewcommand{\labelenumiii}{\theenumiii}
\renewcommand{\labelenumiv}{\theenumiv}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Mathematics

% Packages %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{amsmath,amsthm,amscd,amsfonts,amssymb}
\usepackage{cases}
\usepackage[all]{xy}

\allowdisplaybreaks[4]
\numberwithin{equation}{section}

% Customised notation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\providecommand{\abs}[1]{\lvert#1\rvert}                 % Absolute value
\providecommand{\absbig}[1]{\bigl\lvert#1\bigr\rvert}    % Absolute value
\providecommand{\absBig}[1]{\Bigl\lvert#1\Bigr\rvert}    % Absolute value
\providecommand{\absbigg}[1]{\biggl\lvert#1\biggr\rvert} % Absolute value

\providecommand{\norm}[1]{\lVert#1\rVert}              % Norm
\providecommand{\normbig}[1]{\bigl\lVert#1\bigr\rVert} % Norm
\providecommand{\normBig}[1]{\Bigl\lVert#1\Bigr\rVert} % Norm

\providecommand{\floor}[1]{\left\lfloor#1\right\rfloor}   % Floor
\providecommand{\floorts}[1]{\lfloor#1\rfloor}            % Floor
\providecommand{\floorbig}[1]{\bigl\lfloor#1\bigr\rfloor} % Floor
\providecommand{\floorBig}[1]{\Bigl\lfloor#1\Bigr\rfloor} % Floor

\providecommand{\ceil}[1]{\left\lceil#1\right\rceil}   % Ceiling
\providecommand{\ceilts}[1]{\lceil#1\rceil}            % Ceiling
\providecommand{\ceilbig}[1]{\bigl\lceil#1\bigr\rceil} % Ceiling
\providecommand{\ceilBig}[1]{\Bigl\lceil#1\Bigr\rceil} % Ceiling

\newcommand{\NN}{\mathbf{N}} % Natural numbers
\newcommand{\ZZ}{\mathbf{Z}} % Integers
\newcommand{\QQ}{\mathbf{Q}} % Rationals
\newcommand{\RR}{\mathbf{R}} % Real numbers
\newcommand{\CC}{\mathbf{C}} % Complex numbers
\newcommand{\FF}{\mathbf{F}} % Finite field

\renewcommand{\to}{\rightarrow}        % Right arrow
\newcommand{\into}{\hookrightarrow}    % Injection arrow
\newcommand{\onto}{\twoheadrightarrow} % Surjection arrow

\DeclareMathOperator{\fCoKer}{coker} % Cokernel
\DeclareMathOperator{\fKer}{ker}     % Kernel
\DeclareMathOperator{\fIm}{im}       % Image

\DeclareMathOperator{\Res}{Res}   % Resultant
\DeclareMathOperator{\Tr}{Tr}     % Trace
\DeclareMathOperator{\Trace}{Tr}  % Trace
\DeclareMathOperator{\Norm}{N}    % Norm
\DeclareMathOperator{\Disc}{Disc} % Discriminant

\DeclareMathOperator{\Gal}{Gal}          % Galois group
\DeclareMathOperator{\ord}{ord}          % Order
\DeclareMathOperator{\sgn}{sgn}          % Sign, signature
\DeclareMathOperator{\Frob}{\mathcal{F}} % Frobenius
\DeclareMathOperator{\Hom}{Hom}          % Space of homomorphisms
\DeclareMathOperator{\Spec}{Spec}        % Spectrum

\providecommand{\HdR}{H_{\text{dR}}}    % de Rham cohomology
\providecommand{\Het}{H_{\text{\'et}}}  % etale cohomology
\providecommand{\Hrig}{H_{\text{rig}}}  % rigid cohomology

\providecommand{\cB}{\mathcal{B}} % Basis
\providecommand{\cR}{\mathcal{R}} % Row index set
\providecommand{\cC}{\mathcal{C}} % Column index set
\providecommand{\cM}{\mathcal{M}} % Complexity of multiplication

\providecommand{\BigOh}{\mathcal{O}} % Big-oh notation

% Theorems etc %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\theoremstyle{definition}

\newtheorem{thm}{Theorem}[section]
\newtheorem{lem}[thm]{Lemma}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{cor}[thm]{Corollary}
\newtheorem{defn}[thm]{Definition}
\newtheorem{exmp}[thm]{Example}
\newtheorem{rem}[thm]{Remark}
\newtheorem{prob}[thm]{Problem}

% Roman numerals %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter
\newcommand{\rmnum}[1]{\romannumeral #1}
\newcommand{\Rmnum}[1]{\expandafter\@slowromancap\romannumeral #1@}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DOCUMENT                                                                    %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\maketitle

\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introduction}
\label{sec:Introduction}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Theoretical background}
\label{sec:Background}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Computing in de~Rham cohomology}
\label{sec:deRham}

In this section we recall how to compute in the algebraic de~Rham 
cohomology space $\HdR^{n}(\mathfrak{U}/\mathfrak{S})$ of the complement 
$\mathfrak{U}/\mathfrak{S}$ of a family of smooth hypersurfaces 
$\mathfrak{X}/\mathfrak{S}$ contained in $\mathbf{P}^n_{\mathfrak{S}}$ 
following the method of Griffiths and Dwork.  As we prefer to perform linear 
algebra operations over a field, we will mainly work with the de~Rham 
cohomology vector space $\HdR^{n}(\mathfrak{U}_L)$ of the generic fiber 
$\mathfrak{U}_L = \mathfrak{U}/\mathfrak{S} \times_{\mathfrak{S}} \Spec{L}$, 
where $L=K(t)$ denotes the function field of $\mathfrak{S}$. 

\begin{thm}
Let $\Omega$ denote the $n$-form $\Omega$ in $\HdR^{n}(\mathfrak{U}_L)$ 
defined by 
\begin{equation}
\Omega = \sum_{i=0}^n (-1)^i x_i d x_0 \wedge \dotsb \wedge \widehat{d x_i} \wedge \dotsb \wedge d x_n.
\end{equation}
The algebraic de~Rham cohomology space $\HdR^{n}(\mathfrak{U}_L)$ is 
isomorphic as an $L$-vector space to the quotient of the space of closed $n$-forms 
$Q \Omega / P^k$ with $k \in \NN$ and $Q \in L[x_0, x_1, \dotsc, x_n]$ 
homogeneous of degree $k d - (n + 1)$, by the subspace of exact $n$-forms generated by
\begin{equation} \label{eq:deRhamRel}
\frac{(\partial_i Q) \Omega}{P^k} - k \frac{Q (\partial_i P) \Omega}{P^{k+1}},
\end{equation}
for all $0 \leq i \leq n$ and with $k \in \NN$ and $Q \in L[x_0, x_1, \dotsc, x_n]$ 
homogeneous of degree $kd-n$, where $\partial_i$ denotes the partial derivative operator 
with respect to~$x_i$.
\end{thm}

\begin{proof}
See for example Griffiths~\citep[\S 4]{Griffiths1969}.
\end{proof}

The cohomology space $\HdR^{n}(\mathfrak{U}_L)$ is equipped with 
an increasing filtration of $L$-vector spaces 
$\{\mathcal{F}_k \HdR^{n}(\mathfrak{U}_L) \}_{k \geq 1}$ 
for which $\mathcal{F}_k \HdR^{n}(\mathfrak{U}_L)$ consists of 
all elements that can be represented by $n$-forms $Q \Omega / P^k$ 
with $Q \in L[x_0, x_1, \dotsc, x_n]$ homogeneous of degree $kd - (n + 1)$. 
It follows from a theorem of Macaulay~\citep[\S 4, (4.11)]{Griffiths1969} 
that $\mathcal{F}_n \HdR^{n}(\mathfrak{U}_L)= \HdR^{n}(\mathfrak{U}_L)$. 
Therefore, a basis for $\HdR^{n}(\mathfrak{U}_L)$ can in principle be 
computed using finite dimensional linear algebra. We now define an explicit 
basis of a simple form for $\HdR^{n}(\mathfrak{U}_L)$ for the families 
that we are interested in.

%TODO perhaps mention that all spaces of polynomials contain Q=0 (annoying)
%TODO mention that F_i is the (reverse) Hodge filtration on H^{n-1}(X) with the correct indices

\begin{defn} \label{defn:MonBasis}
For $k \in \NN$, we define the following sets of monomials: 
\begin{align*}
F_k & = \{ x^i : i \in \mathbf{N}_{0}^{n+1}, \abs{i} = k d - (n+1) \}, \\
B_k & = \{ x^i : i \in \mathbf{N}_{0}^{n+1}, \abs{i} = k d - (n+1) \text{ and $i_j < d-1$ for all $j$}\}, \\
R_k & = F_k - B_k,
\end{align*}
where $x^i = x_0^{i_0} \dotsm x_n^{i_n}$ and $\abs{i} = i_0 + \dotsb + i_n$. 
We also write $\cB_k = \{Q \Omega / P^k : Q \in B_k\}$ and let 
$B = B_1 \cup \dotsb \cup B_n$ and $\cB = \cB_1 \cup \dotsb \cup \cB_n$.
\end{defn}

We will show below that if the family $\mathfrak{X}/{\mathfrak{S}}$ contains 
a diagonal fiber then the set $\cB$ forms a basis for $\HdR^n(\mathfrak{U}_L)$.

\begin{defn} \label{defn:IndexSets}
For $k \in \NN$, we let $C_k^{(0)}$ be the set of monomials of total 
degree $(k-1)d - n$ and then inductively, for $j = 1, \dotsc, n$, define 
$C_k^{(j)}$ to be the set of monomials in $C_k^{(j-1)}$ except for those 
divisible by $x_{j-1}^{d-1}$.  Moreover, we define the multi-set $C_k$ as 
the disjoint union of $C_k^{(0)}, \dotsc, C_k^{(n)}$.  We shall write an 
element of this multi-set as $(j, g)$, when referring to a monomial~$g$ 
in~$C_k^{(j)}$.
\end{defn}

\begin{thm} \label{thm:Isomorphism}
Suppose that the family $\mathfrak{X}/\mathfrak{S}$ of smooth projective
hypersurfaces given by the polynomial~$P$ in $K[t][x_0, \dotsc, x_n]$ contains 
a diagonal fibre.  For $k \in \NN$ and $0 \leq j \leq n$, let $U_k^{(j)}$ be 
the $L$-vector space of polynomials with basis $C_k^{(j)}$, and let $U_k$ 
denote the cartesian product $U_k = U_k^{(0)} \times \dotsb \times U_k^{(n)}$. 
Moreover, let $V_k$ and $W_k$ be the $L$-vector spaces of polynomials with 
bases $F_k$ and $R_k$, respectively, and let $\pi \colon V_k \rightarrow W_k$ 
denote the linear map that sends the elements of $B_k$ to zero and the 
elements of $R_k$ to themselves. %safer formulation, projection not unique
Then the map 
\begin{equation}
\phi_k \colon U_k \to W_k, \; \; \;
(Q_0, \dotsc, Q_n) \mapsto \pi \bigl( Q_0 \partial_0 P + \dotsb + Q_n \partial_n P \bigr)
\end{equation}
is an isomorphism of $L$-vector spaces.
\end{thm}

\begin{proof}
We first show that, for all $k \in \NN$, the multi-sets $R_k$ and $C_k$ 
have the same cardinality.

We construct a bijection $R_k \to C_k$, representing the 
monomials by their exponent tuples.  Let $i = (i_0, \dotsc, i_n)$ be an
element of $R_k$.  If $i_0 \geq d-1$, we define the image as
$(i_0-d-1, i_1, \dotsc, i_n) \in C_k^{(0)}$.  More generally, if 
$i_0 < d-1, \dotsc, i_{j-1} < d-1$ and $i_j \geq d-1$, we define the image as 
$(i_0, \dotsc, i_{j-1}, i_j-(d-1), i_{j+1}, \dotsc, i_n) \in C_k^{(j)}$.  
It is easy to verify that this map is indeed a bijection.

If $R_k$ and $C_k$ are empty, then $U_k$ and $W_k$ are the zero vector spaces, and
the theorem holds trivially. So suppose that $R_k$ and $C_k$ are nonempty, that is to
say, $k \geq n/d + 1$.

In order to establish that the map $\phi_k \colon U_k \to W_k$ is an 
isomorphism of $L$-vector spaces, we look at its matrix with respect to 
the given bases. We define the auxiliary matrix $\Delta_k$ with 
row and column index sets $R_k$ and $C_k$, respectively, as follows.  
Given $f \in R_k$ and $(j,g) \in C_k$, we set the corresponding entry in 
$\Delta_k$ to be the coefficient of the monomial $f/g$ in $\partial_j P$ if 
$g$ divides $f$ and $0$ otherwise.  It is immediate that $\Delta_k$ is the 
matrix representing $\phi_k$ with respect to the bases $C_k$ and $R_k$ of 
$U_k$ and $W_k$, respectively.

The assumption that the family~$\mathfrak{X}/\mathfrak{S}$ contains a diagonal 
hypersurface means that for some~$t_0$ the fibre $\mathfrak{X}_{t_0}$ is 
defined by a polynomial of the form 
\begin{equation}
P_{t_0}(x_0, \dotsc, x_n) = a_0 x_0^d + \dotsb a_n x_n^d
\end{equation}
with $a_0, \dotsc, a_n \in K^{\times}$.

We can now show that the determinant of $\Delta_k$ is nonzero in~$L$.  Since 
specialisation to the diagonal fibre, that is, evaluation of the matrix at 
$t = t_0$, commutes with computing the determinant, it suffices to show that 
the determinant of $(\Delta_k) \big |_{t=t_0}$ is nonzero.  Since, for 
$0 \leq j \leq n$, we have $\partial_j P_{t_0} (x_0, \dotsc, x_n) = d a_j x_j^{d-1}$, 
there is precisely one nonzero entry in each column and each row of $\Delta_k$.  
Namely, in column $(j, g) \in C_k$ and row $g x_j^{d-1} \in R_k$ there is the 
nonzero entry $d a_j$, concluding the proof.
\end{proof}

We can use Theorem~\ref{thm:Isomorphism} to give a routine {\sc Decompose}, 
formalised in Algorithm~\ref{alg:Decompose}, which given 
$Q \in L[x_0, \dotsc, x_n]$ homogeneous of degree $kd - (n+1)$, 
returns an expression 
\begin{equation}
Q = Q_0 \partial_0 P + \dotsb + Q_n \partial_n P + \gamma_k
\end{equation} 
with $Q_0, \dotsc, Q_n \in L[x_0, \dotsc, x_n]$ homogeneous of 
degree $kd-n$ and $\gamma_k$ in the $L$-span of $B_k$. We can in turn 
use {\sc Decompose} to furnish another routine {\sc Reduce}, formalised 
in Algorithm~\ref{alg:PoleRed}, which given a closed $n$-form $Q\Omega/P^k$ 
with $Q \in L[x_0, \dotsc, x_n]$ homogeneous of degree $kd - (n+1)$ returns 
an expression
\begin{equation}
Q \Omega / P^k \equiv \gamma_{1} \Omega / P^{1} + \dotsb + \gamma_n \Omega / P^n,
\end{equation}
with $\gamma_i$ in the $L$-span of $B_i$ for $1 \leq i \leq n$ and 
where $\equiv$ denotes equality in cohomology.

\begin{algorithm}[ht]
\caption{Obtain coordinates in the Jacobian ideal modulo basis elements}
\label{alg:Decompose}
\begin{algorithmic}
\Require  $P$ in $K[t][x_0, \dotsc, x_n]$ homogeneous of degree~$d$, 
         defining a family $\mathfrak{X}/\mathfrak{S}$ of smooth projective 
         hypersurfaces that contains a diagonal fibre, $Q \in L[x_0, \dotsc, x_n]$ homogeneous of degree $kd - (n+1)$.
\Ensure  $Q_0, \dotsc, Q_n \in L[x_0, \dotsc, x_n]$ homogeneous of degree 
         $k(d-1)-n$, and $\gamma_k$ in the $L$-span of $B_k$, such that 
         $Q = Q_0 \partial P_0 + \dotsb + Q_n \partial_n P +\gamma_k$.
\Procedure{Decompose}{$P,Q$}
\State \begin{compactenum}[\it {Step} I.] \vspace{-1.24em}
\item Let $b$ be the vector of length $\abs{R_k}$ such that the entry 
      corresponding to the monomial $x^i \in R_k$ is the coefficient of 
      $x^i$ in $Q$.
\item Let $v$ be the unique vector of length $\abs{C_k}$ satisfying 
      $\Delta_k v = b$.  From the definition of $C_k$, we can write $v$ 
      accordingly as $\bigl(v^{(0)}, \dotsc, v^{(n)}\bigr)$ 
      where $v^{(j)}$ is a vector of length $\abs{C_k^{(j)}}$ 
      for $0 \leq j \leq n$.
\item For $j = 0, \dotsc, n$, set $Q_j = \sum_{g \in C_k^{(j)}} v_g^{(j)} g$,
      where $v_g^{(j)}$ is the entry in $v^{(j)}$ corresponding to the 
      monomial $g \in C_k^{(j)}$, and set $\gamma_k = Q-(Q_0 \partial P_0 + \dotsb + Q_n \partial_n P)$.
\item \textbf{return} $Q_0, \dotsc, Q_n,\gamma_k$.
\end{compactenum}
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}
\caption{Reduce $Q \Omega / P^k$ in $\HdR^n(\mathfrak{U}_L)$}
\label{alg:PoleRed}
\begin{algorithmic}
\vspace{1mm}
\Require  $P$ in $K[t][x_0, \dotsc, x_n]$ homogeneous of degree~$d$, 
         defining a family $\mathfrak{X}/\mathfrak{S}$ of smooth projective 
         hypersurfaces that contains a diagonal fibre, $Q \in L[x_0, \dotsc, x_n]$ 
         homogeneous of degree $kd - (n+1)$.
\Ensure  $\gamma_i$ in the $L$-span of $B_i$ for $1 \leq i \leq n$, with  
         $Q \Omega / P^k \equiv \gamma_{1} \Omega / P^{1} + \dotsb + \gamma_n \Omega / P^n$.
\Procedure{Reduce}{$P,Q$}
\While{$k \geq n+1$}
\State $Q_0, \dotsc, Q_n, \bullet \gets \Call{Decompose}{Q}$
\State $k \gets k-1$
\State $Q \gets k^{-1} \sum_{i=0}^n \partial_i Q_i$
\EndWhile
\While{$Q \not \in B_k$}
\State $Q_0, \dotsc, Q_n, \gamma_k \gets \Call{Decompose}{Q}$
\State $k \gets k-1$
\State $Q \gets k^{-1} \sum_{i=0}^n \partial_i Q_i$
\EndWhile
\If{$Q \neq 0$}
\State $\gamma_{k} \gets Q$
\State $k \gets k-1$
\EndIf
\State $\gamma_{1}, \dotsc, \gamma_{k} \gets 0$
\State \textbf{return} $\gamma_{1}, \dotsc, \gamma_n$
\EndProcedure
\end{algorithmic}
\end{algorithm}

We now finally establish that the set~$\cB$ indeed forms a basis for 
$\HdR^n(\mathfrak{U}_L)$, as announced before.  We begin with an 
auxiliary result describing the cardinality of the set~$\cB$.

\begin{prop} \label{prop:BasisSize}
The set $\cB$ has cardinality
\begin{equation}
\bigl((d-1)/d\bigr) \bigl((d-1)^{n} - (-1)^{n}\bigr).
\end{equation}
\end{prop}

\begin{proof}
First note that if we denote
\begin{align*}
V &= \{(i_0,\cdots,i_n) \in (\ZZ/d\ZZ)^{n+1} : \sum_{j=0}^n i_j = n+1\}, \\
H_j &= \{(i_0,\cdots,i_n) \in (\ZZ/d\ZZ)^{n+1} : i_j = -1 \},
\end{align*}
then  $\cB$ is in one-to-one correspondence with the set $V-(H_0 \cup \cdots \cup H_n)$. Now by the inclusion-exclusion
principle, 
\begin{align*}
\abs{V \cap (H_0 \cup \cdots \cup H_n)} &= \sum_{j=0}^n \abs{V \cap H_j} - \sum_{0 \leq j < k \leq n} \abs{V \cap H_j \cap H_k}
+ \cdots + (-1)^{n} \abs{V \cap H_0 \cap \cdots \cap H_n} \\
&= {n+1 \choose 1} d^{n-1} -{n+1 \choose 2} d^{n-2} + \cdots + (-1)^{n-1} {n+1 \choose n} + (-1)^{n} \\
&= (1/d)\bigl(d^{n+1}+(-1)^{n+1} - (d-1)^{n+1}\bigr)+(-1)^n,
\end{align*}
so that
\begin{align*}
\abs{V-(H_0 \cup \cdots \cup H_n)}&=\abs{V}-\abs{V \cap (H_0 \cup \cdots \cup H_n)} \\
&= d^n - (1/d)\bigl(d^{n+1}+(-1)^{n+1} - (d-1)^{n+1}+d (-1)^n \bigr) \\
&= \bigl((d-1)/d\bigr) \bigl((d-1)^{n} - (-1)^{n}\bigr),
\end{align*}
and the proof is complete.
\end{proof}

\begin{thm} \label{thm:Basis}
Suppose that the family of smooth projective hypersurfaces $\mathfrak{X}/\mathfrak{S}$ 
contains a diagonal fibre.  Then the set~$\cB$ from Definition~\ref{defn:MonBasis} 
is a basis for the $L$-vector space $\HdR^n(\mathfrak{U}_L)$.
\end{thm}

\begin{proof}
We already know that $\HdR^n(\mathfrak{U}_L)$ is spanned by the classes of the 
$n$-forms $Q \Omega / P^k$ with $Q \in L[x_0, \dotsc, x_n]$ homogeneous of degree 
$kd - (n+1)$ for $k \in \NN$. Applying Algorithm ~\ref{alg:PoleRed}, we obtain an 
expression for the class of $Q \Omega / P^k$ as an $L$-linear combination of 
elements in $\cB$.  This shows that $\cB$ spans the vector space 
$\HdR^n(\mathfrak{U}_L)$. However, we know from [[TODO reference]] that 
$\dim \HdR^n(\mathfrak{U}_L) = \bigl((d-1)/d\bigr) \bigl( (d-1)^n - (-1)^n \bigr)$.  
Therefore, it follows from Proposition~\ref{prop:BasisSize} that $\cB$ is linearly 
independent as well.
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Computing the connection matrix}
\label{sec:Connection}

We now describe the action of the Gauss--Manin connection~$\nabla$ on 
$\HdR^n(\mathfrak{U}_L)$.  Suppose that we are given a basis element 
$x^i \Omega / P^k \in \cB_k$.  Following the description in Section [[TODO]], 
we compute
\begin{equation} \label{eqn:nabla}
\nabla \biggl(\frac{x^i \Omega}{P^k}\biggr) \equiv 
dt \otimes \frac{- k x^i P_t \Omega}{P^{k+1}},
\end{equation}
where $P_t = dP/dt$ and $\equiv$ denotes equality in 
$\Omega_{L} \otimes \HdR^n(\mathfrak{U}_L)$. We apply 
Algorithm~\ref{alg:PoleRed} in order to write
\begin{equation}
dt \otimes \frac{- k x^i P_t \Omega}{P^{k+1}} \equiv 
dt \otimes \left( \frac{\gamma_{1}}{P} + \dotsb + \frac{\gamma_n}{P^n} \right) \Omega
\end{equation}
where $\gamma_i$ is an element in the $L$-span of~$B_i$ for $1 \leq i \leq n$. This is
formalised in Algorithm~\ref{alg:Connection} below.

\begin{algorithm}
\caption{Compute the Gauss--Manin connection matrix}
\label{alg:Connection}
\begin{algorithmic}
\Require $P$ in $K[t][x_0, \dotsc, x_n]$ homogeneous of degree~$d$, 
         defining a family $\mathfrak{X}/\mathfrak{S}$ of smooth projective 
         hypersurfaces that contains a diagonal fibre.
\Ensure  The matrix~$M$ of $\nabla$ with respect to $\cB$.
\Procedure{GMConnection}{$P$}
\State \begin{compactenum}[\it {Step} I.] \vspace{-1.24em}
\item Compute the auxiliary matrices $\Delta_k$  as defined 
      in the proof of Theorem~\ref{thm:Isomorphism}
      for $k = \floor{n/d}+1, \dotsc, n+1$.
\item For each $g \in B$, let $k = (\deg(g)+(n+1))/d$ and $Q = - k g P_t$. 
      Set $\gamma_{1}, \dotsc, \gamma_n$ to the output of 
      {\sc Reduce($P,Q$)}. For each $f \in B$ let $M_{f,g}$ 
      be the coefficient of $f$ in $\gamma_i$.
\item \textbf{return} $M$.
\end{compactenum}
\EndProcedure
\end{algorithmic}
\end{algorithm}

%TODO there should be a remark, or small subsection, on sparse linear algebra
%here.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Frobenius on diagonal hypersurfaces}
\label{sec:Diagonal}

\subsection{Introduction}

In this section we compute the action of Frobenius on the cohomology 
space $\Hrig^{n}(U_0) \cong \HdR^{n}(\mathfrak{U}_0)$ associated 
to the diagonal fibre of the family. Our method is based on an 
explicit formula of Dwork~\citep[\S 4]{Dwork1964}, which has already 
appeared in the work of Lauder~\citep[\S 6]{Lauder2004b} and 
Gerkmann~\citep[\S 4.4]{Gerkmann2007}. However, by rewriting this formula 
we obtain an algorithm that performs significantly better in practice 
than direct implementation.

In order to simplify our notation, we temporarily suppress the earlier 
setup of a family of hypersurfaces. Thus, we consider a single smooth 
projective diagonal hypersurface~$\mathcal{X}$ over $\ZZ_p$ defined by 
a polynomial $P \in \ZZ_p[x_0, \dotsc, x_n]$ of the form
\begin{equation}
P(x_0, x_1, \dotsc, x_n) = 
    a_0 x_0^d + a_1 x_1^d + \dotsb + a_n x_n^d,
\end{equation}
where $a_0, a_1, \dotsc, a_n \in \ZZ_p^{\times}$ and $p \nmid d$. 
Let $\mathfrak{X} = \mathcal{X} \otimes_{\ZZ_p} \QQ_p$ denote the generic 
fibre of $\mathcal{X}$ and let $\mathcal{U}$ and $\mathfrak{U}$ be the complements
of $\mathcal{X}$ and $\mathfrak{X}$, respectively. 
We fix our choice of basis~$\cB$ for $\HdR^{n}(\mathfrak{U})$ 
as in Definition~\ref{defn:MonBasis}. 

Our goal is to compute 
the matrix~$\Phi$ representing the action of $p^{-1} \Frob_p$ on 
$\Hrig^n(U) \cong \HdR^n(\mathfrak{U})$, with respect to the basis~$\cB$, 
to $p$-adic precision~$N$.

We first describe an explicit formula for the $\dim \HdR^n(\mathfrak{U})$ 
nonzero coefficients of~$\Phi$ due to Dwork~\citep{Dwork1964},
see also Lauder~\citep[\S 6.1]{Lauder2004b}.  
We work over the ramified extension~$\QQ_p(\pi)$ where $\pi^{p-1} = -p$, 
and normalise the valuation such that \mbox{$\ord_p(\pi) = (p-1)^{-1}$}.

Let $u = (u_0, \dotsc, u_n)$ and $v = (v_0, \dotsc, v_n)$ be tuples 
of integers such that $x^u, x^v \in B$ and $p (u_i+1) \equiv v_i+1 \pmod{d}$
for all $i$. Furthermore, let $k_u$ and $k_v$ denote integers such that 
$d k_u = \sum_{i=0}^n (u_i + 1)$ and similarly for $k_v$.  For $m \geq 0$, 
let $\lambda_m$ denote the coefficient of $z^m$ in the power series expansion 
of $\exp \pi (z - z^p)$ and define products $(w)_r = \prod_{j=0}^{r-1} (w + j)$ 
for $w \in \QQ$ and $r \geq 0$. We introduce terms
\begin{equation} \label{eq:alpha}
\alpha_{u,v} = \pi^{k_v - k_u} \prod_{i = 0}^n \sum_{m, r} \lambda_m ((u_i + 1) / d)_r (-1)^r \pi^{-r} {\hat{a}_i}^{m-r},
\end{equation}
where $\hat{a}_i \in \ZZ_p$ denotes the Teichm\"uller lift of 
$a_i \in \mathbf{F}_p$ and the summation indices $m, r \geq 0$ 
satisfy $p (u_i+1) - (v_i+1) = d (m - pr)$.

\begin{rem}
We could eliminate $m$ from Equation \eqref{eq:alpha} by writing 
\[
m(r)=\frac{p(u_i+1) - (v_i+1)}{d}+pr.
\]
Note that $p(u_i+1) - (v_i+1) \geq 0$, since it is divisible by $d$ and greater than $-d$.
So after eliminating $m$, the sum would just be over all $r \geq 0$. However, to simplify
notation, we will keep the index $m$.
\end{rem}

\begin{thm} \label{thm:01-03-diagfrob}
Let $\omega_1$ denote an element of $\cB$ corresponding to a tuple 
$u \in \ZZ^{n+1}$ and let $\omega_2$ denote the unique element of~$\cB$ 
corresponding to a tuple $v \in \ZZ^{n+1}$ such that
we have $p (u_i + 1) \equiv v_i + 1 \pmod{d}$ for all $i$. Then
\begin{equation}
p^{-1} \Frob_p (\omega_1) = 
    (-1)^{k_u + k_v} \frac{(k_v - 1)!}{(k_u - 1)!} p^n \alpha_{u,v}^{-1} \omega_2.
\end{equation}
\end{thm}

\begin{proof}
See Dwork~\citep[\S 4]{Dwork1964} or Lauder~\citep[\S 6.1]{Lauder2004b}.  
Both references also treat the more general case when $\mathcal{X}$ is 
a smooth projective diagonal hypersurface over $\ZZ_q$, for $q$ a prime 
power.
\end{proof}

\subsection{Improvements}

At first sight it appears that this computation genuinely has to 
take place in the extension field~$\QQ_p(\pi)$.  This is, however, 
not the case as we will show now.  The terms $\alpha_{u,v}$ 
will turn out to be elements of~$\ZZ_p$. We provide expressions 
for them that are more suitable for computations.

First, it is straightforward to obtain a more explicit description 
of the coefficients~$\lambda_m$ via an elementary calculation:

\begin{lem} \label{lem:lambdam}
Let $\pi^{p-1} = -p$ and, for $m \geq 0$, let $\lambda_m$ 
be the coefficient of $z^m$ in the power series expansion 
of $\exp \pi (z - z^p)$ in $\QQ_p[[z]]$.  Then 
\begin{equation}
\pi^{- (m \bmod{(p-1)})} \lambda_m = (-1)^{\floor{m/(p-1)}} \sum_{k=0}^{\floor{m/p}} p^{\floor{m/(p-1)} - k} \frac{1}{(m-pk)! k!}
\end{equation}
where $m \bmod{(p-1)}$ denotes the remainder of $m$ upon Euclidean 
division by $p-1$. \hfill $\qedsymbol$
\end{lem}

We can apply this lemma in conjunction with the definition 
of the quantities $\alpha_{u, v}$.  Upon observing that 
$m - r \bmod{(p-1)}$ only depends on $u$ and $v$, we obtain 
the following theorem.

\begin{thm} \label{thm:alpha}
Let $u, v \in \ZZ^{n+1}$ be such that 
$x^u, x^v \in B$ and 
$p (u_i + 1) \equiv v_i + 1 \pmod{d}$ for all~$i$. 
Then 
\begin{equation}
\alpha_{u,v} = (-p)^{k_u} \prod_{i=0}^n 
    \hat{a}_i^{(p (u_i + 1) - (v_i + 1))/d} \sum_{m,r} 
    \Bigl(\frac{u_i+1}{d}\Bigr)_r 
    \sum_{k=0}^{\floor{m/p}} \frac{p^{r-k}}{(m-pk)! k!}.
\end{equation}
where $m, r \geq 0$ satisfy $p (u_i + 1) - (v_i + 1) = d (m - pr)$.
\end{thm}

\begin{proof}
We begin from the definition of $\alpha_{u+1,v+1}$ 
and use Lemma~\ref{lem:lambdam} to find that $\alpha_{u+1,v+1}$ 
is equal to 
\begin{gather*}
\pi^{k_v-k_u} \prod_{i=0}^n \sum_{m,r} (-1)^{\floor{m/(p-1)}} \pi^{m \bmod{(p-1)}} \biggl( \sum_{k=0}^{\floor{m/p}} \frac{p^{\floor{m/(p-1)}-k}}{(m-pk)!k!} \biggr) \Bigl( \frac{u_i+1}{d} \Bigr)_r (-1)^r \pi^{-r} \hat{a}_i^{m-r}.
\intertext{We now write $m = \floor{m/(p-1)} (p-1) + \bigl(m \bmod{(p-1)}\bigr)$ and simplify by $\pi^{p-1} = -p$, so this expression is equal to}
\pi^{k_v-k_u} \prod_{i=0}^n \sum_{m,r} \pi^{m - r} \biggl( \sum_{k=0}^{\floor{m/p}} \frac{p^{-k}}{(m-pk)!k!} \biggr) \Bigl( \frac{u_i+1}{d} \Bigr)_r (-1)^r \hat{a}_i^{m-r}. \\
\intertext{Using that $m-r = (p-1)r + \bigl(p(u_i+1) - (v_i+1)\bigr)/d$, we arrive at}
\pi^{k_v-k_u} \prod_{i=0}^n \pi^{(p (u_i + 1) - (v_i + 1))/d} \hat{a}_i^{(p (u_i + 1) - (v_i + 1))/d} \sum_{m,r} \biggl( \sum_{k=0}^{\floor{m/p}} \frac{p^{r-k}}{(m-pk)!k!} \biggr) \Bigl( \frac{u_i+1}{d} \Bigr)_r \\
\intertext{and finally}
(-p)^{k_u} \prod_{i=0}^n \hat{a}_i^{(p (u_i + 1) - (v_i + 1))/d} \sum_{m,r} \Bigl( \frac{u_i+1}{d} \Bigr)_r \sum_{k=0}^{\floor{m/p}} \frac{p^{r-k}}{(m-pk)!k!},
\end{gather*}
as required.
\end{proof}

In particular, Theorem~\ref{thm:alpha} implies that 
$\alpha_{u, v} \in \QQ_p$.  Our next aim is to show
that $\alpha_{u,v}$ is $p$-adically integral.  First, we collect a few 
intermediate results.

\begin{prop} \label{prop:mpr1}
Let $x^u, x^v \in B$ and 
$m, r \geq 0$ such that $d(m-pr) = p(u_i + 1) - (v_i + 1)$ for all $i$.  Then 
\begin{equation}
0 \leq m - p r \leq \frac{p(d-1)-1}{d}.
\end{equation}
\end{prop}

\begin{proof}
This can be easily verified using that $0 \leq u_i, v_i \leq d - 2$ 
and $m - pr \in \ZZ$.
\end{proof}

\begin{prop} \label{prop:mpr2}
Let $x^u, x^v \in B$ and $m, r \geq 0$ such that 
$d(m-pr) = p(u_i + 1) - (v_i + 1)$ for all~$i$.  Then 
\begin{equation}
r - \floor{\frac{m}{p}} \geq 0.
\end{equation}
\end{prop}

\begin{proof}
Using the previous proposition,
\begin{equation}
r - \floor{\frac{m}{p}} 
= - \floor{\frac{m-pr}{p}} 
\geq - \floor{\frac{p(d-1)-1}{pd}} 
= -1 + \ceil{\frac{p + 1}{pd}} 
= 0 
\end{equation}
as $p \geq 2$ and $d \geq 2$.
\end{proof}

\begin{prop} \label{prop:rfac}
For all integers $u, d \geq 1$ and $r \geq 0$ with $p \nmid d$, 
\begin{equation}
\ord_p\Bigl(\frac{u}{d}\Bigr)_r \geq \frac{r}{p-1} - \floor{\log_p(r) + 1}.
\end{equation}
\end{prop}

\begin{proof}
Let $s_p(r)$ denote the sum of digits in the $p$-adic expansion of~$r$ 
and observe that $s_p(r) \leq (p-1)\floor{\log_p(r) + 1}$.  Using the 
standard fact that $\ord_p\bigl((u/d)_r\bigr) \geq \ord_p(r!)$, 
it follows that 
\begin{equation}
\ord_p\Bigl(\frac{u}{d}\Bigr)_r \geq \ord_p(r!) = \frac{r - s_p(r)}{p-1} \geq \frac{r}{p-1} - \floor{\log_p(r) + 1}
\end{equation}
as required.
\end{proof}

\subsubsection{The case $p = 2$}

We first note that in the case when $p = 2$, the expression for 
$\lambda_m$ in Lemma~\ref{lem:lambdam} can be simplified:

\begin{lem} \label{lem:mu2}
For $p = 2$ we define a sequence $\bigl(\mu_m^{(2)}\bigr)$ by 
\begin{equation}
\mu_m^{(2)} = 
    \sum_{k=0}^{\floor{m/2}} \frac{2^{\floor{3m/4} - \nu_m - k}}{(m-2k)! k!}
\end{equation}
where $\nu_m$ is equal to one whenever $m = 3, 7$ and zero otherwise, 
and we write $\mu_m =\mu_m^{(2)}$ whenever this does not cause confusion. 
Then $\mu_m \in \ZZ_2$ for all $m \geq 0$.
\end{lem}

\begin{proof}
In the two cases $m = 3, 7$ we explicitly compute the values of 
$\mu_m$ as $4/3$ and $232/315$.  Now suppose that $m \neq 3, 7$. 
From Lemma~\ref{lem:lambdam} we obtain that 
\begin{equation*}
\ord_2 \bigl(\mu_m\bigr) 
    = \floor{3m/4} - m + \ord_2(\lambda_m).
\end{equation*}
Using the bound $\ord_p(\lambda_m) \geq \bigl((p-1)/p^2\bigr) m$ from 
Dwork~\citep[pp.~55--57]{Dwork1962}, we obtain that 
\begin{equation*}
\ord_2 \bigl(\mu_m\bigr) 
    \geq \floor{3m/4} - m + \ceil{\frac{m}{4}} = 0. \qedhere
\end{equation*}
\end{proof}

\begin{thm} \label{thm:alpha2}
Let $p = 2$ and suppose $u, v \in \ZZ^{n+1}$ are such that 
$x^u, x^v \in B$ and $p (u_i + 1) \equiv v_i + 1 \pmod{d}$ 
for all~$i$.  Then $\alpha_{u,v}$ can be expressed as 
\begin{equation} \label{eq:alpha2.0}
\alpha_{u,v} = (-2)^{k_u} \prod_{i=0}^n \sum_{m,r} 
    \Bigl(\frac{u_i+1}{d}\Bigr)_r 2^{-\floor{(m+1)/4}+\nu_m} \mu_m, 
\end{equation}
and $\alpha_{u,v}$ is a $2$-adic integer.
\end{thm}

\begin{proof}
The expression for $\alpha_{u,v}$ is an immediate consequence 
of Theorem~\ref{thm:alpha} and Lemma~\ref{lem:mu2}, together with 
Proposition~\ref{prop:mpr1} implying $0 \leq m - 2r \leq 1$ and 
hence $r = \floor{m/2}$.  It remains to prove that 
$\alpha_{u,v}$ is a $2$-adic integer.  Following Lemma~\ref{lem:mu2}, 
it suffices to show that the valuation of the factor 
\begin{equation} \label{eq:fr}
f_r=\Bigl(\frac{u_i+1}{d}\Bigr)_r 2^{- \floor{(m+1)/4} + \nu_m}
\end{equation}
in each summand is nonnegative.  From the proof of 
Proposition~\ref{prop:rfac} we get that 
\begin{equation} \label{eq:alpha2.1}
\ord_p(f_r)
\geq \ord_p\Bigl(\floor{\frac{m}{2}}!\Bigr) - \floor{\frac{m+1}{4}} + \nu_m.
\end{equation}
Applying Proposition~\ref{prop:rfac}, we see that the right-hand side 
is bounded below by 
\begin{equation}
\floor{\frac{m}{2}} - \floor{\frac{m+1}{4}} - \floor{\log_2 m}
\end{equation}
which is nonnegative whenever $m \geq 12$.  In the remaining 
cases $m = 0, \dotsc, 11$, we explicitly verify that the 
lower bound in~\eqref{eq:alpha2.1} is nonnegative.
\end{proof}

\begin{rem}
We observe that in Equation~\eqref{eq:alpha2.0} the exponent 
$-\floor{(m+1)/4}+\nu_m$ is nonpositive for each value $m \geq 0$, 
so at first sight it seems that the computation of the $f_r$ from
\eqref{eq:fr} will suffer from precision loss. However, the $f_r$
can be computed recursively using:
\begin{align*}
f_0 &=1, \; \; \; f_1=\frac{u_i+1}{d} \\
f_r & = f_{r-2} \frac{(u + (r - 2)d)(u + (r - 1)d)}{2d^2} ,
\end{align*}
(Strictly speaking this formula only holds for $r \neq 5$, but one can write down a similar formula for $r=5$).
Since $d$ is odd when $p=2$, the numerator is always even and the denominator is odd,
so this computation can be carried out without precision loss.
\end{rem}

\subsubsection{The case $p > 2$}

\begin{lem} \label{lem:mup}
Let $p \geq 3$ be an odd prime and define a sequence 
$\bigl(\mu_m^{(p)}\bigr)$ by 
\begin{equation}
\mu_m^{(p)} = \sum_{k=0}^{\floor{m/p}} \frac{p^{\floor{m/p} - k}}{(m-pk)! k!}, 
\end{equation}
where we write $\mu_m = \mu_m^{(p)}$ when the prime can be identified 
from the context.  Then $\mu_m \in \ZZ_p$ for all $m \geq 0$.
\end{lem}

\begin{proof}
It is clear that $\mu_m \in \QQ$.  From Lemma~\ref{lem:lambdam} 
we observe that $\lambda_m = \pi^m p^{- \floor{m/p}} \mu_m$.  Using the 
bound $\ord_p(\lambda_m) \geq \bigl((p-1)/p^2\bigr) m$ 
from Dwork~\citep[pp.~55--57]{Dwork1962}, it follows that 
\begin{equation}
\ord_p (\mu_m) \geq \frac{p-1}{p^2} m + \floor{\frac{m}{p}} - \frac{m}{p-1}.
\end{equation}
Let us write $m = q p + r$ with $0 \leq r \leq p-1$.  As the valuation 
of $\mu_m$ is an integer, it suffices to show that, for $q \geq 0$, 
\begin{equation}
\frac{p-1}{p} q + q - \frac{q p + p - 1}{p - 1} > -1,
\end{equation}
which is equivalent to $p^2 - 3p + 1 > 0$, and this holds true 
provided that $p \geq 3$.
\end{proof}

\begin{thm} \label{thm:alphap}
Let $p \geq 3$ and suppose that $u, v \in \ZZ^{n+1}$ are such 
that $x^u, x^v \in B$ and 
$p (u_i + 1) \equiv v_i + 1 \pmod{d}$ for all~$i$. Then 
\begin{equation} \label{eq:alphap.0}
\alpha_{u,v} = (-p)^{k_u} \prod_{i=0}^n 
    \hat{a}_i^{(p (u_i + 1) - (v_i + 1))/d} \sum_{m,r} 
    \Bigl(\frac{u_i+1}{d}\Bigr)_r p^{r - \floor{m/p}} \mu_m
\end{equation}
where $m, r \geq 0$ satisfy $p (u_i + 1) - (v_i + 1) = d (m - pr)$. 
In particular, $\alpha_{u, v} \in \ZZ_p$. 
\end{thm}

\begin{proof}
This follows from Theorem~\ref{thm:alpha}, Proposition~\ref{prop:mpr2} 
and Lemma~\ref{lem:mup}.
\end{proof}

\subsection{Description of the algorithm}

If we want to use Theorem \ref{thm:01-03-diagfrob} to compute the matrix 
$\Phi$ to $p$-adic precision $N$, then we have to compute the elements
$(k_u-1)!\alpha_{u,v}$ to a somewhat higher precision $\tilde{N}$ than just
$N-n$, because 
of the loss of precision in computing their inverses. Note that if a $p$-adic 
number $x$ is known with (absolute) precision $k$, then its inverse is in general 
only known with precision $k-2\ord_p(x)$. Therefore, we need an upper bound
on the $p$-adic valuation of the elements $(k_u-1)!\alpha_{u,v}$.

\begin{prop}
The valuation of $(k_u-1)! \alpha_{u,v}$ satisfies
\begin{equation}
\ord_p\bigl((k_u-1)! \alpha_{u,v}\bigr) 
    \leq \ord_p\bigl((n-1)!\bigr) + n + \delta,
\end{equation}
where $\delta = \ord_p\bigl((n-1)!\bigr) + (n+1) \floor{\log_p(n-1)}$. 
\end{prop}

\begin{proof}
Recall from section [[TODO]] that the valuations 
of the entries of the matrix~$\Phi$ are bounded from below by $-\delta$. 
Thus, by Theorem~\ref{thm:01-03-diagfrob}, 
\begin{equation}
-\delta \leq \ord_p\bigl((k_v-1)!\bigr) + n 
           - \ord_p\bigl((k_u-1)! \alpha_{u,v}\bigr)
\end{equation}
Noting that $d k_v = \sum_{i=0}^n (v_i + 1) \leq n d$ and 
hence $k_v \leq n$, the result follows.
\end{proof}

\begin{cor}
To compute the matrix $\Phi$ with $p$-adic precision $N$, it is sufficient to compute the elements 
$(k_u-1)!\alpha_{u,v}$ with $p$-adic precision
\begin{equation}
\tilde{N}=N-n+2(\ord_p\bigl((n-1)!\bigr)+n+\delta).
\end{equation}
\end{cor}

Up to this point, the sum over $m,r$ in our expressions 
for $\alpha_{u,v}$ has been an infinite sum.  We now present 
a convergence result, that will allow us to derive a finite 
expression for $(k_u-1)!\alpha_{u,v}$ modulo $p^{\tilde{N}}$. We
start with an elementary lemma.

\begin{lem} \label{lem:log}
Given integers $b,c \geq 2$ and defining $x = c + \log_b c + 1$ 
we have that, for all real numbers $y \geq x$, 
\begin{equation}
y - \log_b y \geq c.
\end{equation}
\end{lem}

\begin{proof}
We first note that the function $y \mapsto y - \log_b y$ is increasing 
for $y \geq 2$ because it has derivative $1 - \log_b(e)/y > 0$.  Thus, it 
suffices to verify the result for $x$.  Indeed, as $c \geq 2$ we have 
that $\log_b c + 1 \leq c$, hence $c + \log_b c + 1 \leq b^{\log_b c + 1}$,
which upon taking logarithms and rearranging yields the result.
\end{proof}

\begin{prop}
In order to compute $(k_u-1)!\alpha_{u,v} \bmod p^{\tilde{N}}$, it 
suffices to restrict the inner sum in Equation~\eqref{eq:alpha2.0} or 
\eqref{eq:alphap.0} to pairs $m,r \geq 0$ such that $m \leq M$, or 
equivalently $r \leq R$, where 
\begin{equation}
M = \floor{ p^2 \biggl( \frac{\tilde{N}}{p-1} +2 
            + \log_p\Bigl(\frac{\tilde{N}}{p-1} + 2\Bigr) + 1 \biggr)}, \; \; \; R=\floor{M/p}.
\end{equation}
\end{prop}

\begin{proof}
This follows from~\citep[\S 6.2]{Lauder2004b} and Lemma~\ref{lem:log}.
%TODO check this in Lauder's paper
\end{proof}

Finally, we describe how to compute an approximation to the matrix~$\Phi$ 
representing the action of $p^{-1} \Frob_p$ on $\Hrig^{n}(U)$ using our 
previous results. This allows us to formalise the procedure for computing 
the entries of~$\Phi$ modulo~$p^N$ in Algorithm~\ref{alg:Diabfrob} 
below.

\begin{algorithm}
\caption{Compute the matrix for $p^{-1} \Frob_p$ on $\HdR^n(\mathfrak{U})$}
\label{alg:Diabfrob}
\begin{algorithmic}
\vspace{1mm}
\Require $P=a_0 x_0^d + \dotsb + a_n x_n^d$ 
         with $a_0,\dotsc,a_n \in \ZZ_p^{\times}$, 
         $p$-adic precision~$N \geq 0$.
\Ensure  Matrix $\Phi$ for action of $p^{-1} \Frob_p$ on $\HdR^n(\mathfrak{U})$ with respect to basis $\cB$ modulo $p^N$.
\Procedure{DiagFrob}{$P,N$}
\State \begin{compactenum}[\it {Step} I.] \vspace{-1.24em}
\item Determine $\tilde{N}$, $M$ and $R$. Precompute the Teichm\"uller lifts $\hat{a}_0, \dotsc, \hat{a}_n$, 
      and the sequences $(d^{-r})_{r=0}^R$ and $(\mu_m)_{m=0}^{M}$, 
      to $p$-adic precision~$\tilde{N}$.
\item For each monomial $x^u \in B$, 
      determine the unique monomial $x^v \in B$ such that 
      $v_i = p (u_i + 1) - 1 \bmod{d}$.  Use the following steps to 
      compute the entry at position $(u,v)$ in the matrix $\Phi$.
      \begin{enumerate}
\item Compute the expression $x_1 = (-1)^{k_u+k_v} (k_v-1)! p^n$ as an 
      exact integer [[TODO, what is the right precision here?]].
\item Compute the expression $x_2 = (k_u - 1)! \alpha_{u,v}$ to 
      precision~$\tilde{N}$ using Equation~\eqref{eq:alpha2.0} or 
      \eqref{eq:alphap.0}, depending on whether $p$ is even or odd. 
\item Compute the inverse $x_2^{-1}$ to precision $N - n$.
\item Finally, compute the product $x_1 x_2^{-1}$ to precision~$N$.
      \end{enumerate}
\end{compactenum}
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{rem} \label{rem:mup}
The expressions for $\mu_m$ can be computed using integer arithmetic 
modulo~$p^{\tilde{N}}$ via 
\begin{equation}
\mu_m^{(p)} = \begin{cases}
\frac{1}{m!} \sum_{k=0}^{\floor{m/2}} 2^{\floor{3m/4} - k} \frac{m!}{(m-2k)! k!}
    & \text{if $p = 2$, $m \neq 3, 7$} \\
\frac{1}{m!} \sum_{k=0}^{\floor{m/p}} p^{\floor{m/p} - k} \frac{m!}{(m-pk)! k!}
    & \text{if $p$ is odd},
\end{cases}
\end{equation}
with only one $p$-adic inversion as all summands are integers. Moreover, 
we observe that the summands are integers of size $\BigOh(m \log m)$ bits, 
which also allows us to avoid performing intermediate reductions 
modulo~$p^{\tilde{N}}$.
\end{rem}

%TODO put all the complexity stuff together at the end, and max a couple
%of pages total
\begin{comment}
\begin{thm} \label{thm:DiagfrobComplexity1}
The time complexity of Algorithm~\ref{alg:Diabfrob} is given by 
\begin{equation*}
p \tilde{N}^2 \cM\bigl(p \tilde{N} \log (p \tilde{N})\bigr)
    + d^n n \bigl( \cM(\log d) + (\tilde{N} + \log p) \cM(\tilde{N} \log p) \bigr)
\end{equation*}
where $\cM(-)$ denotes the complexity of integer multiplication and 
$\tilde{N}$ is $\BigOh(N + n \log_p n)$.
\end{thm}

\begin{proof}
We consider each of the steps in Algorithm~\ref{alg:Diabfrob}. 
We can ignore the computational cost of {Step~(i)}, but observe 
that $\tilde{N} \in \BigOh(N + n \log_p n)$, 
$M \in \BigOh(p \tilde{N})$, and $R \in \BigOh(\tilde{N})$.  

In {Step~(ii)}, we compute $n+1$ Teichm\"uller lifts with an 
overall complexity of $\BigOh(n (\log p) \cM(\tilde{N} \log p))$. 
The computation of the sequence $(d^{-r})_{r=0}^{R}$ requires 
one reduction of $d$ modulo $p^{\tilde{N}}$, one $p$-adic inversion 
and $R-1$~products to precision~$\tilde{N}$, yielding 
$\BigOh\bigl(\cM(\log d) + (\log \log p) \cM(\log p) + \tilde{N} \cM(\tilde{N} \log p)\bigr)$. 
Finally, we carry out the computation of $(\mu_m)_{m=0}^{M}$ following 
Remark~\ref{rem:mup}, which requires time 
$\BigOh\bigl(p \tilde{N}^2 \cM(p \tilde{N} \log(p \tilde{N}))\bigr)$.

The following {Steps~(iii) through (vii)} are executed 
$\dim \Hrig^{n}(U)$ times, where this dimension 
is $\BigOh(d^n)$.
The time complexity of {Step~(iii)} is 
$\BigOh\bigl(n \cM(\log \max\{p,d\})\bigr)$.
We observe that we can ignore {Step~(iv)}.
Step~(v) involves an $(n+1)$-fold product of series 
with~$\BigOh(R)$ terms modulo~$p^{\tilde{N}}$, where each summand 
requires an absolutely bounded number of products, as well as 
$n+1$~exponentiations of Teichm\"uller lifts with exponents given 
by $d^{-1} \bigl(p (u_i+1) - (v_i+1)\bigr) < p$.  Computing the 
exponents has complexity $\BigOh(\cM(\log \max\{p,d\}))$ and 
we note that we may ignore the update of the term 
\mbox{$\bigl((u_i+1)/d\bigr)_r$} throughout the summation 
assuming we have computed the reduction of $d \bmod{p^{\tilde{N}}}$ 
once and for all earlier.  Therefore, the complexity of each 
invocation of {Step~(v)} is 
$\BigOh\bigl( n \cM(\log d) + n (R + \log p) \cM(\tilde{N} \log p)\bigr)$.  
The $p$-adic inverse in {Step~(vi)} requires time 
$\BigOh\bigl((\log \log p) \cM(\log p) + \cM(\tilde{N} \log p)\bigr)$.
Finally, we can ignore the product in {Step~(vii)}.  
Thus, the aggregate time complexity of {Steps~(iii)} through {(vii)} 
is given by 
$\BigOh\bigl(d^n n \bigl( \cM(\log d) + (\tilde{N} + \log p) \cM(\tilde{N} \log p) \bigr)\bigr)$.
\end{proof}

While the current implementation of Algorithm~\ref{alg:Diabfrob} 
performs very well in practice, its time complexity is quasi-cubic in 
the $p$-adic precision~$N$, which is \emph{not} optimal.  Both of 
these aspects are due to the use of the sequence $(\mu_m)_{m=0}^{M}$ 
defined over $\ZZ_p$ instead of the coefficients $(\lambda_m)_{m=0}^{M}$ 
defined over $\QQ_p(\pi)$.  We can achieve a better time complexity by 
utilising fast exponentials of power series:

\begin{thm} \label{thm:DiagfrobComplexity2}
There exists an algorithm for computing the matrix for the 
action of $p^{-1} \Frob_p$ on $\Hrig^{n}(U)$ in time complexity 
\begin{equation*}
(M \log M \log \log M) (p \log p) \cM(\tilde{N} \log p) 
+ d^n n \bigl( \cM(\log d) 
              + \tilde{N} (p \log p) \cM(\tilde{N} \log p) \bigr)
\end{equation*}
where $\cM(-)$ denotes the complexity of integer multiplication 
and $\tilde{N} \in \BigOh(N + n \log_p n)$, $M \in \BigOh(p \tilde{N})$.
\end{thm}

\begin{proof}
The key idea is to slightly modify Algorithm~\ref{alg:Diabfrob} 
and use Equation~\eqref{eq:alpha}, working directly with the sequence 
$(\lambda_m)_{m=0}^{M}$.  As we will be using operations in the 
totally ramified extension~$\QQ_p(\pi)$ to 
$p$-adic precision~$\tilde{N}$, we remark that the cost of 
an arithmetic operation in its ring of integers is 
$\BigOh\bigl((p \log p) \cM(\tilde{N} \log p)\bigr)$, 
achieved by polynomial multiplication based on the fast Fourier 
transform.

We first observe that the valuation of the summands in 
Equation~\eqref{eq:alpha} can be bounded by 
$\ord_p \bigl(\lambda_m (u_i / d)_r (-1)^r \pi^{-r} {\hat{a}_i}^{m-r} \bigr) \geq - 1/2$.
As the only term with negative valuation is $\pi^{-r}$ and 
$R \in \BigOh(\tilde{N})$, it suffices to precompute 
the sequences $(\lambda_m)_{m=0}^{M}$ and $(d^{-r})_{r=0}^{R}$ 
to $p$-adic precision $\tilde{N}$.  While the computation 
of the latter remains unchanged, the computation of the former 
can be improved significantly using fast exponentials of 
power series in $\QQ_p(\pi)[[z]]$ as described by 
Bernstein~\citep[\S 9.3]{Bernstein2008}.  This allows for 
computing the sequence $(\lambda_m)_{m=0}^{M}$ in 
$\BigOh\bigl( (M \log M \log \log M) \bigr)$ operations 
in~$\QQ_p(\pi)$ to precision~$\tilde{N}$.  The only 
remaining change to our analysis of Algorithm~\ref{alg:Diabfrob} 
occurs in {Step~(v)}, where for each matrix entry we have to consider 
$\BigOh(n R)$ multiplications in~$\QQ_p(\pi)$ instead 
of~$\ZZ_p$.
\end{proof}
\end{comment}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Solving the differential equation}
\label{sec:DifferentialSystem}

In this section we explain how to solve the $p$-adic differential 
equation describing the horizontal sections of the Gauss--Manin 
connection $\nabla$, in order to obtain a local expansion of the 
matrix for the action of $p^{-1} \Frob_p$ on $\Hrig^{n}(U/S)$.  
Our discussion largely follows the work of Lauder~\citep{Lauder2006}, 
but incorporates improved convergence bounds from Kedlaya~\citep{Kedlaya2010}.



Recall that $\Phi$ denotes the matrix for the $\sigma$-semilinear action
of~$p^{-1} \Frob_p$ on $\Hrig^{n}(U/S)$ with respect to the basis $\cB$, 
where $\sigma$ is the standard lift of the $p$th-power Frobenius sending 
$t \mapsto t^p$. Also recall that $M \in M_{b \times b}(\QQ_q(t))$ denotes 
the matrix for the Gauss--Manin connection $\nabla$ on $\HdR^n(\mathfrak{U}/\mathfrak{S})$
with respect to the same basis. As we saw in section [[TODO]], these matrices 
satisfy the differential equation

\begin{equation} \label{eq:Phi}
\Bigl(\frac{d}{dt} + M\Bigr) \Phi = p t^{p-1} \Phi \sigma(M), \; \; \; \Phi(0)=\Phi_0,
\end{equation}
where $\Phi_0 \in M_{b \times b}(\QQ_p)$ is the matrix for the action of $p^{-1} \Frob_p$ 
on $\Hrig^n(U_0)$, again with respect to the basis $\cB$. Our goal is 
the computation of a power series expansion of~$\Phi$ around the origin.

We first observe that if $C \in M_{b \times b}(\QQ_q[[t]])$ denotes the unique solution to the 
homogeneous system
\begin{equation} \label{eq:01-GMDE-Homogenous}
\Bigl(\frac{d}{dt} + M\Bigr) C = 0, \; \; \; C(0)=I,
\end{equation}
where $I$ denotes the identity matrix, then the matrix
\begin{equation*}
\Phi = C \Phi_0 \sigma(C)^{-1}
\end{equation*}
satisfies Equation \eqref{eq:Phi}. So it is sufficient to solve Equation 
\eqref{eq:01-GMDE-Homogenous}.

Let us write 
\begin{equation*}
M = \frac{B(t)}{r(t)},
\end{equation*}
where $B(t) = \sum_{i=0}^{\deg(B)} B_i t^i$ and $r(t)= \sum_{i=0}^{\deg(r)} r_i t^i$,
with $B_i \in M_{b \times b}(\QQ_q)$ and $r_i \in \ZZ_q$, for all $i$. By our assumption 
[[TODO]], we may suppose that $r_0 \neq 0 \pmod{p}$, so in particular $r_0 \neq 0$.

We can now obtain a power series solution $C = \sum_{i \geq 0} C_i t^i$ around $t=0$ for 
the equation
\begin{equation*}
r \frac{dC}{dt} + B C = 0, \; \; \; C(0)=I,
\end{equation*}
which is clearly equivalent to Equation \eqref{eq:01-GMDE-Homogenous}, using the recursion 
\begin{align} \label{eq:Ci}
C_0 &= I, \\ \label{eq:recursion}
C_{i+1} &= \frac{-1}{r_0 (i+1)} \biggl(
    \sum_{j=\max{\{0,i-\deg(B)\}}}^i B_{i-j} C_j + 
    \sum_{j=\max{\{0,i-\deg(r)\}}+1}^i r_{i-j+1} (j C_j) \biggr).
\end{align}

However, we will carry out this computation to some finite $p$-adic working precision $\tilde{N}$. If
we want $C$ to be correct to $p$-adic precision $N$, then $\tilde{N}$ has to be somewhat greater than $N$, 
because of error propagation. A bound for $\tilde{N}$, in terms of $N$ and the desired $t$-adic precision, 
was given by Lauder~\citep[Theorem~5.1]{Lauder2006}, but his result can be improved significantly by including 
more recent bounds on the valuation of $C_0, C_1, \dotsc$ by Kedlaya~\citep{Kedlaya2010}, as we will now show.  

\begin{thm} \label{thm:valC}
For all $i \geq 1$, the $p$-adic valuation of the matrix~$C_i$ 
satisfies 
\begin{equation*}
\ord_p(C_i) \geq - \bigl(2 \delta + (n - 1)\bigr) \ceil{\log_p i}.
\end{equation*}
\end{thm}

\begin{proof}
It follows from Theorem~{18.3.3} in Kedlaya~\citep{Kedlaya2010} that
\begin{equation*}
\ord_p(C_i) \geq \bigl( \ord_p(\Phi) + \ord_p(\Phi^{-1}) \bigr) \ceil{\log_p i}.
\end{equation*}
However, by [[TODO]], we know that $\ord_p(\Phi) \geq -\delta$ and 
$\ord_p(p^{n-1}\Phi^{-1}) \geq -\delta$, so
\begin{equation*}
\ord_p(\Phi) + \ord_p(\Phi^{-1}) \geq - 2 \delta - (n-1),
\end{equation*}
and the result follows.
\end{proof}

\begin{rem}
Kedlaya~\citep[Remark~18.3.4]{Kedlaya2010} also includes the bound
\begin{equation*}
\ord_p(C_i) \geq (b - 1) \ord_p(M) 
            - \bigl( \ord_p(\Phi) + \ord_p(\Phi^{-1}) \bigr) \floor{\log_p i},
\end{equation*}
which can sometimes be used to improve the bound from the previous theorem slightly, 
for example when $\ord_p(M)$ is positive.
\end{rem}

Now let $D_0, D_1, \dotsc$ denote an approximation to $C_0, C_1, \dotsc$ 
defined by the recursion
\begin{align*}
D_0 &= I \\
D_{i+1} &= \frac{-1}{r_0 (i+1)} \biggl(
    \sum_{j=\max{\{0,i-\deg(B)\}}}^i B_{i-j} D_j + 
    \sum_{j=\max{\{0,i-\deg(r)\}}+1}^i r_{i-j+1} j D_j \biggr) + 
    p^{\tilde{N}} E_{i+1},
\end{align*}
where $(E_i)_{i \geq 1}$ is a sequence of $p$-adically integral matrices i.e., the matrices $D_0, D_1, \dotsc$
are computed with working precision $\tilde{N}$.

\begin{thm}
For all $i \geq 1$, 
\begin{equation*}
\ord_p(C_i - D_i) \geq 
    \tilde{N} - \Bigl(2 \bigl(2 \delta + (n-1)\bigr) + 1\Bigr) \ceil{\log_p i}.
\end{equation*}
\end{thm}

\begin{proof}
This follows analogously to
Lauder~\citep[Theorem~5.1]{Lauder2006}.  
Indeed, the proof there shows that 
\begin{equation*}
\ord_p(C_i - D_i) \geq 
    \tilde{N} + \min_{k+\ell=i} \Bigl(\ord_p(C_k) + 
                                      \ord_p(\ell^{-1} C_{\ell-1}^{-1})\Bigr).
\end{equation*}
We use the bound from Theorem~\ref{thm:valC} and observe that it 
also applies to the inverse matrix~$C^{-1}$, as this matrix satisfies 
the dual differential equation 
\begin{equation} \label{eq:01-GMDE-Dual}
\Bigl(\frac{d}{dt} - M^t\Bigr) \bigl(C^{-1}\bigr)^t = 0, \; \; \; C^{-1}(0)=I
\end{equation}
that carries a Frobenius structure given by the matrix $\bigl(\Phi^{-1}\bigr)^t$. 
The result now follows.
\end{proof}

\begin{rem}
In order to determine the power series expansion of the matrix~$\Phi$, 
we also need to compute the matrix $\sigma(C)^{-1}$. The matrix~$C^{-1}$ 
can be computed using matrix inversion over the ring $\mathbf{Q}_q[[t]]$.  
An alternative approach follows from observing that $C^{-1}$ 
satisfies Equation~\eqref{eq:01-GMDE-Dual}. In practice, solving this 
equation for $C^{-1}$ is typically favourable compared to inverting 
the matrix~$C$.
\end{rem}

We need to recall some bounds on the loss of $p$-adic precision when
multiplying $p$-adic numbers and matrices.

%Todo perhaps move the following propositions somewhere else, they don't
%really belong here.

\begin{prop} \label{prop:productval}
Let $x_1, \dotsc, x_{\ell} \in \mathbf{Q}_q$, where $\ell \geq 2$, 
be given as $x_i = p^{v_i} u_i$ with $v_i = \ord_p(x_i) \in \mathbf{Z}$ 
and $u_i \in \mathbf{Z}_q^{\times}$ whenever $x_i \neq 0$ and 
$u_i = v_i = 0$ otherwise.  Suppose that $N \in \mathbf{Z}$ is given 
such that $N > \sum_{j=1}^{\ell} v_j$ and, for all $i$, $N > \sum_{j \neq i} v_j$.

Let $\tilde{x}_1, \dotsc, \tilde{x}_{\ell}$ be $p$-adic approximations 
satisfying $\ord_p(x_i - \tilde{x}_i) \geq N - \sum_{j \neq i} v_j$ 
for all $i$.  Then 
\begin{equation}
\ord_p(x_1 \dotsm x_{\ell} - \tilde{x}_1 \dotsm \tilde{x}_{\ell}) \geq N.
\end{equation}
\end{prop}

\begin{proof}
The proof is straightforward, relying only on elementary properties on 
the $p$-adic valuation.
\end{proof}

\begin{prop} \label{prop:matrixproductval}
Let $A_1, \dotsc, A_{\ell}$ be $b \times b$ matrices over $\mathbf{Q}_q$, 
where $\ell \geq 2$, given as $A_i = p^{v_i} U_i$ with 
$v_i = \ord_p(A_i) \in \mathbf{Z}$ and at least one entry of $U_i$ a 
$p$-adic unit $A_i \neq 0$ and $v_i = 0$ and $U_i$ the zero matrix 
otherwise.  Suppose that $N \in \mathbf{Z}$ is given such that 
$N > \sum_{j=1}^{\ell} v_j$ and, for all $i$, $N > \sum_{j \neq i} v_j$.

Let $\tilde{A}_1, \dotsc, \tilde{A}_{\ell}$ be $p$-adic approximations 
satisfying $\ord_p(A_i - \tilde{A}_i) \geq N - \sum_{j \neq i} v_j$ 
for all $i$.  Then 
\begin{equation}
\ord_p(A_1 \dotsm A_{\ell} - \tilde{A}_1 \dotsm \tilde{A}_{\ell}) \geq N.
\end{equation}
\end{prop}

\begin{proof}
We can follow the proof of Proposition~\ref{prop:productval}, 
observing that, for matrices $A$, $B$ over $\mathbf{Q}_q$, 
we have $\ord_p(A + B) \geq \min \{\ord_p(A), \ord_p(B)\}$.
\end{proof}

\begin{thm}
In order to compute the power series expansion of the matrix $\Phi$ at $t=0$ with $t$-adic
precision $K$ and $p$-adic precsion $N$ (i.e., modulo $t^K$ and $p^N$), it is sufficient
to compute:
\begin{itemize}
\item $\Phi_0$ to $p$-adic precision $N+\bigl(2\delta+(n-1)\bigr) \bigl(\ceil{\log_p K} + \ceil{\log_p \floor{K/p}}\bigr)$,
\item $C$ to $t$-adic precision $K$ and $p$-adic precision $N+\bigl(2\delta+(n-1)\bigr) \ceil{\log_p \floor{K/p}} + \delta$,
\item $C^{-1}$ to $t$-adic precision $\floor{K/p}$ and $p$-adic precision $N+\bigl(2\delta+(n-1)\bigr) \ceil{\log_p K} + \delta$.
\end{itemize}
Therefore, while solving Equation \eqref{eq:01-GMDE-Homogenous} for $C$ and Equation \eqref{eq:01-GMDE-Dual} for $C^{-1}$, using 
a recursion like Equation \eqref{eq:recursion}, it is sufficient to use $p$-adic working precision
\begin{itemize}
\item $\tilde{N}=N+\Bigl(2 \bigl(2 \delta + (n-1)\bigr) + 1\Bigr) \ceil{\log_p K}$ and 
\item $\tilde{N}=N+\Bigl(2 \bigl(2 \delta + (n-1)\bigr) + 1\Bigr) \ceil{\log_p \floor{K/p}}$, respectively.
\end{itemize}
\end{thm}

\begin{proof}

\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Analytic continuation and evaluation}
\label{sec:Evaluation}

In the previous section we described how to compute the matrix~$\Phi$ 
for the action of $p^{-1} \Frob_p$ on $\Hrig^{n}(U/S)$ 
as a local power series expansion around $t = 0$.  In order to evaluate it 
at a second point $t = t_1$, we wish to $p$-adically approximate it 
using rational functions with denominators a power of $r(t)$, which 
is possible as the entries of the matrix~$\Phi$ are overconvergent 
functions.

The analytic continuation of the local expansion is described by Lauder 
in~\citep[\S 5.2]{Lauder2006} and the computational details are explained 
in~\citep[\S 8.1]{Lauder2004a}.  Combining this step with the subsequent 
evaluation, our specific problem is the following.  Given a desired 
$p$-adic precision~$N_2$, we would like to determine integers~$K_1$ 
and~$K_2$ such that, modulo~$p^{N_2}$, the entries of the matrix 
$\Psi(t) = r(t)^{K_1} \Phi(t)$ truncated modulo~$t^{K_2}$ allow us to 
compute the matrix $\Phi_{t_1}$ for the action of $p^{-1} \Frob_p$ 
on $\Hrig^{n}(U_{t_1})$ as $r(\hat{t_1})^{-1} \Psi(\hat{t_1})$.

Besides the work of Lauder~\citep[\S 8.1]{Lauder2004a}, there are also 
suitable results by Gerkmann~\citep[\S 6]{Gerkmann2007}, however the 
estimates are not sharp in practice.  There has been recent progress by 
Kedlaya and Tuitman~\citep[Theorem~2.1]{KedlayaTuitman2012}, which we 
present in a slightly simplified form:

\begin{thm} \label{thm:KedlayaTuitman}
Let $\mathfrak{Z}$ denote the complement of the open dense 
subscheme $\mathfrak{S}$ of $\mathbf{P}^{1}(\mathbf{Q}_q)$ 
and let $z$ be an unramified geometric point of $\mathfrak{Z}$ 
such that $\mathfrak{Z}$ does not contain any other points 
with the same reduction modulo~$p$.  For a fixed a basis for 
$\Hrig^n(U/S)$, suppose that the matrix 
for the connection~$\nabla$ has at most a simple pole at~$z$ 
and that the exponents $\lambda_1, \dotsc, \lambda_{b}$, 
which are defined as the eigenvalues of $(t - z) M \vert_{t=z}$ 
and known to be rational numbers, have nonnegative $p$-adic 
valuation.  Then the matrix~$\Phi$ for the action of $p^{-1} \Frob_p$ 
has a pole at $z$ of order at most 
\begin{equation} \label{eq:KedlayaTuitman}
\max_{i} \lambda_i - p \min_{i} \lambda_i + p g(N)
\end{equation}
where $g(N)$ is defined by 
\begin{equation}
g(N) = \max\Bigl\{ i \in \mathbf{N} : i - \delta - \bigl(2\delta + (n-1)\bigr) \ceil{\log_p i} < N \Bigr\}.
\end{equation}
\end{thm}

\begin{proof}
See \citep[Theorem~2.1]{KedlayaTuitman2012}.
\end{proof}

[[TODO:  Please rewrite the above theorem and include whichever 
form and notation you see fit.]]

\begin{rem} \label{rem:KedlayaTuitman}
In practice, it might be convenient to avoid computing the exponents and 
verifying the hypotheses of the previous theorem.  This is particularly 
relevant since even when the hypotheses are not satisfied, the required 
bounds are often closer to the result of Kedlaya and Tuitman than to the 
estimates provided by Gerkmann.

The contribution of the terms $\max_i \lambda_i - p \min_i \lambda_i$ 
in Equation~\eqref{eq:KedlayaTuitman} typically is small compared to the 
term~$p g(N_2)$. Therefore, in a heuristic implementation, one 
could choose e.g.\ $K_1 = 1.1 \times p N_2$ and $K_2 = (\deg(r) + 1) K_1$.
\end{rem}

Having obtained an expression for the action of~$p^{-1} \Frob_p$ 
on~$\Hrig^{n}(U_{t_1})$ in terms of rational functions, we can 
compute the matrix $\Phi_{t_1}$ representing $p^{-1} \Frob_p$ on 
$\Hrig^{n}(U_{t_1})$ modulo~$p^{N_2}$ as 
\begin{equation}
\Phi_{t_1} = 
    r(\hat{t}_1)^{-K_1} 
    \Bigl( r(t)^{K_1} \Phi(t) \bmod{t^{K_2}} \Bigr) \Big\vert_{t=\hat{t}_1} \pmod{p^{N_2}}.
\end{equation}
Since, by assumption, $r(t_1)$ is a $p$-adic unit and hence so is 
$r(\hat{t}_1)^{-K_1}$ we observe that it suffices to compute the 
Teichm\"uller lift~$\hat{t}_1$ and the matrix~$r(t)^{K_1} \Phi(t)$ 
over~$\mathbf{Q}_p[t]$ to $p$-adic precision~$N_2$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Recovering the zeta function of a fiber}
\label{sec:ZetaFunctions}

Recall that the zeta function of the hypersurface~$X_{t_1}$ is of the form,
\begin{equation}
Z(X_{t_1},T) = \frac{p(T)^{(-1)^n}}{(1 - T) (1 - qT) \dotsm (1 - q^{n-1}T)}
\end{equation}
where $p(T) = \det \bigl( 1 - T q^{-1} \Frob_q | \Hrig^n(U_{t_1}) \bigr)$ 
is a polynomial defined over the integers.
Thus, the remaining two steps in the deformation method are now clear.  
Firstly, we determine the action of the $q$th-power Frobenius 
from that of the $p$th-power Frobenius.  Secondly, we compute 
its reverse characteristic polynomial to suitable \mbox{$p$-adic} 
precision in order to recover the zeta function.

\subsection{Computing the action of $q^{-1} \Frob_q$ on $\Hrig^{n}(U_{t_1})$}

As before, let $\Phi_{t_1}$ and $\Phi_{t_1}^{(q)}$ denote the matrices 
representing the actions of $p^{-1} \Frob_p$ and $q^{-1} \Frob_q$ 
on~$\Hrig^{n}(U_{t_1})$, respectively.  As the action of $p^{-1} \Frob_p$ 
is $\sigma$-semilinear, we have that 
\begin{equation}
\Phi_{t_1}^{(q)} = 
    \Phi_{t_1} \sigma(\Phi_{t_1}) \dotsm \sigma^{a-1}(\Phi_{t_1}),
\end{equation}
where $a = \log_p q$.  Note that the lift of Frobenius~$\sigma$ 
is valuation preserving and hence the valuations of the matrices 
$\Phi_{t_1}, \sigma(\Phi_{t_1}), \dotsc, \sigma^{a-1}(\Phi_{t_1})$ 
are at least $-\delta$ by [[TODO: Reference]].
In particular, it follows that in order to determine $\Phi_{t_1}^{(q)}$ 
to $p$-adic precision~$N_1$ it suffices to provide $\Phi_{t_1}$ to 
precision $N_2 \geq N_1 + (a-1) \delta$.

\subsection{Computing Weil polynomials}

Before considering Weil polynomials, we briefly address the loss 
of precision when computing the reverse characteristic polynomial 
$\det(1 - t A)$ of a $b \times b$ matrix~$A$ given to finite precision 
over $\mathbf{Q}_p$.  In general, from the elementary definition of the 
determinant function, it appears that the precision loss could be as 
great as $(b-1) \ord_p(A)$.  However, in the case of matrices representing 
the action of Frobenius on $\Hrig^n(U_{t_1})$, much better bounds are 
available:

\begin{lem}
Define $\delta = \delta(n,p)$ as in Lemma~[[TODO: Reference]] and 
suppose that $\tilde{\Phi}_{t_1}^{(q)}$ is an approximation to 
$\Phi_{t_1}^{(q)}$ with 
$\ord_p\bigl(\Phi_{t_1}^{(q)}-\tilde{\Phi}_{t_1}^{(q)}\bigr) \geq N + \delta$.
Then 
\begin{equation}
\ord_p \Bigl( \det\bigl(1 - t \Phi_{t_1}^{(q)}\bigr) 
            - \det\bigl(1 - t \tilde{\Phi}_{t_1}^{(q)}\bigr) \Bigr) \geq N.
\end{equation}
\end{lem}

\begin{proof} 
See Gerkmann~\citep[Lemma~3.3, Lemma~3.4]{Gerkmann2007}.
\end{proof}

The previous lemma allows us to take $N_1 = N_0 + \delta$ in our 
description of the deformation algorithm.

Finally, we compute the 
reverse characteristic polynomial $p(T)$ of the matrix $\Phi_{t_1}^{(q)}$, 
which represents $q^{-1} \Frob_q$ on $\Hrig^n(U_{t_1})$, to some finite 
$p$-adic precision.  Which precision~$N_0$ is necessary in order to 
correctly recover the polynomial~$p(T)$ over the integers?

\begin{thm} \label{thm:N0}
In order to recover $p(T)$ over $\mathbf{Z}$ it suffices to compute 
an approximation modulo~$p^N$ where 
\begin{equation}
p^N > 2 \max_{0 \leq i \leq b} \binom{b}{i} q^{i (n-1) / 2}.
\end{equation}
Moreover, this can be improved to 
\begin{equation}
p^N > 2 \binom{b}{\floor{b/2}} q^{\floor{b/2} (n-1) / 2}
\end{equation}
provided that the sign $\epsilon = \sgn(\det(F_q))$ of the 
functional equation for the zeta function is known.
\end{thm}

\begin{proof}
This is a slight reformulation of {Theorem~3.2} in~\citep{Gerkmann2007}, 
which follows readily from its proof.
\end{proof}

\begin{rem}
We observe that the sign $\epsilon = \sgn(\det(q^{-1} \Frob_q)) = 1$ 
whenever $n$ is even.  [[TODO: Give justification.  If nothing else, 
include this in the statement of the Weil conjectures.]]
\end{rem}

\begin{rem}
In the case that $n$ is odd, the sign~$\epsilon$ of the functional 
equation is unknown a priori.  However, in practice it is often still 
possible to avoid having to use the greater of the two precisions in 
Theorem~\ref{thm:N0} by just computing one additional coefficient 
exactly.  Writing $p(T) = \sum_{i=0}^{b} a_i T^i$, we can recover 
$a_0, \dotsc, a_{\floor{b/2}+1}$ exactly provided 
\begin{equation}
p^N > 2 \max\biggl\{\binom{b}{\floor{b/2}} q^{\floor{b/2} (n-1) / 2}, 
                   \binom{b}{\floor{b/2}+1} q^{(\floor{b/2}+1) (n-1)/2} \biggr\}.
\end{equation}
This allows us to determine the sign~$\epsilon$ from the two 
coefficients $a_{\ceil{b/2}-1}$ and $a_{\floor{b/2}+1}$, provided 
that they are nonzero, and we can then recover the remaining 
coefficients using the functional equation.
\end{rem}

\begin{rem} \label{rem:N0Surfaces}
In the case of smooth projective surfaces, when $p > 2$ and subject to 
certain technical conditions, we can often exploit the growing divisibility 
of the coefficients of $p(T)$ ensured by the Hodge polygon.  For such a surface 
of degree~$d$, we know that the Hodge numbers $h_{0,2}$, $h_{1,1}$ and $h_{2,0}$ 
satisfy $h_{0,2} = h_{2,0} = \binom{d-1}{3}$ and $2 h_{0,2} + h_{1,1} = b$. 
It is now easier to determine the integer coefficients of the 
polynomial~$q^{h_{0,2}} p(T/q)$ as the roots of the polynomial $p(T/q)$ lie 
on the unit circle.  This allows us to take 
\begin{align*}
N_0 & = a h_{0,2} + \floor{\log_p \biggl( 2 \binom{b}{\floor{b/2}}\biggr)} + 1,\\
N_1 & = N_0 + a,
\end{align*}
where $N_0$ here refers to the required precision for $q^{h_{0,2}} p(T/q)$ 
and $N_1$ as before refers to the precision required for the matrix 
representing $q^{-1} \Frob_q$ on $\Hrig^{n}(U_{t_1})$.
For further details, we refer the reader to 
Lauder~\citep[\S 9.3.2, Proposition~9.6]{Lauder2006}.
\end{rem}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{The algorithm}
\label{sec:Algorithm}

\subsection{Overview of the algorithm}

We now provide an outline of the deformation method.  The list below 
includes nearly full details of the computation, omitting only the 
specific choices of precisions $N_1, \dotsc, N_7$
and $K_1, K_2$. These will be provided and justified later.

\begin{enumerate}
\item[Step~$\Rmnum{1}$.]
Compute the matrix $\Phi_0 \in M_{b \times b}(\mathbf{Q}_q)$ for the action 
of $p^{-1} \Frob_p$ on $\Hrig^{n}(U_0)$ with respect to the standard basis 
to $p$-adic precision~$N_1$.  
\item[Step~$\Rmnum{2}$.]
Compute the matrix $M \in M_{b \times b}(\mathbf{Q}_q(t))$ of the 
Gauss--Manin connection $\nabla$ on $\HdR^{n}(\mathfrak{U}_L)$ with 
respect to the standard basis to $p$-adic precision~$N_2$.
\item[Step~$\Rmnum{3}$.]
Let $C \in M_{b \times b} (\mathbf{Q}_q[[t]])$ denote the matrix of 
local solutions of the connection~$\nabla$ around zero, i.e., 
the matrix that satisfies the $p$-adic differential equation 
$\bigl(\tfrac{d}{dt} + M\bigr) C = 0$ with initial condition $C(0)=I$.  
We compute an approximation for the matrices~$C$ and 
$C^{\sigma}(t^p)^{-1}$ modulo~$t^{K_1}$ to $p$-adic precision~$N_3$.
\item[Step~$\Rmnum{4}$.]
Let $\Phi(t) \in M_{b \times b}(\mathbf{Q}_p\langle t,r(t)^{-1}\rangle^{\dagger})$ 
denote the matrix for the action of $p^{-1} \Frob_p$ on $\Hrig^{n}(U/S)$ with 
respect to the standard basis (which is only a basis generically).  One can 
show that this matrix satisfies $\Phi(t) = C(t) \Phi_0 C^{\sigma}(t^p)^{-1}$.
Using this formula we compute a power series approximation of $\Phi(t)$ 
modulo~$t^{K_1}$ to $p$-adic precision~$N_4$.
\item[Step~$\Rmnum{5}$.]
Let $\Phi_{t_1} \in M_{b \times b}(\mathbf{Q}_q)$ denote the matrix for 
the action of $p^{-1} \Frob_p$ on $\Hrig^{n}(U_{t_1})$. First we compute 
$\Psi(t) = r(t)^{K_2} \Phi(t)$ modulo~$t^{K_1}$ to $p$-adic precision~$N_5$. 
Then we compute an approximation $r(\hat{t}_1)^{-K_1} \Psi(\hat{t}_1)$ for 
$\Phi_{t_1}$ to $p$-adic precision~$N_5$.
\item[Step~$\Rmnum{6}$.]
Let $\Phi_{t_1}^{(q^m)}$ denote the matrix for the action of 
$q^{-m} \Frob_{q^m}$ on $\Hrig^{n}(U_{t_1})$, which satisfies 
$\Phi_{t_1}^{(q^m)} = \Phi_{t_1} \sigma(\Phi_{t_1}) \dotsm \sigma^{a-1}(\Phi_{t_1})$ 
and has entries in $\mathbf{Q}_{q^m}$.  We compute an approximation to 
this matrix with $p$-adic precision~$N_6$.
%TODO change notation for q^m power Frobenius matrix, looks like power of matrix
\item[Step~$\Rmnum{7}$.]
Let $p(T) = \det\bigl(1 - T (q^m)^{-1} \Frob_{q^m} | \Hrig^n(U_{t_1})\bigr)$, 
which is an integer polynomial.  We recover this exactly by computing an 
approximation to the reverse characteristic polynomial of $\Phi_{t_1}^{(q^m)}$
to $p$-adic precision~$N_7$.
\end{enumerate}

\subsection{Precisions}

\subsection{Complexity}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Examples}
\label{sec:Examples}

\subsection{Parallelisation}

From a practical point of view, we observe that the individual steps 
of the algorithm which contribute significantly to the runtime can be 
carried out in parallel:
\begin{itemize}
\item In the implementation of the computation of $p^{-1} \Frob_p$ 
      on $\Hrig^{n}(U_0)$ which is quasi-cubic in the precision, 
      the elements of the sequence $(\mu_m)_{m=0}^{M}$ can be computed 
      independently.
\item The computation of the connection matrix can be parallelised 
      as the computations of the images of the basis vectors for 
      $\HdR^{n}(\mathfrak{U}/\mathfrak{S})$ are independent.
\item The major contributor to the runtime in many examples is the 
      computation of the matrix~$C(t)$ which is the local solution 
      of the differential equation.  While the outer loop in 
      Equation~\eqref{eq:Ci} cannot be parallelised easily 
      as $C_{i}$ depends on certain $C_{j}$ with $j < i$, the 
      matrix products in the inner loop are independent.
\item The computation of the $q$th-power Frobenius 
      $\Phi^{(q)} \sigma(\Phi^{(q)}) \dotsm \sigma^{a-1}(\Phi^{(q)})$, 
      where $a = \log_{p} q$, can be carried out in parallel.  This can 
      be achieved if, instead of computing a running product from left to 
      right, we express the matrix in a product tree.  We formalise this in 
      Algorithm~\ref{alg:ParallelProduct}, assuming for simplicity 
      that $a = 2^k$.  In this notation, the execution of the 
      loops indexed by~$i$ can be parallelised.
      \begin{algorithm}
      \caption{Parallel computation of $q^{-1} \Frob_{q} | \Hrig^{n}(U_{t_1})$}
      \label{alg:ParallelProduct}
      \begin{algorithmic}
      \vspace{1mm}
      \For{$i \gets 0$ \textbf{to} $a-1$}
          \State $G_i \gets \sigma^{i}(F)$
      \EndFor
      \For{$j=k-1$ \textbf{to} $0$}
          \State $h \gets 2^{k-j}$
          \For{$i \gets 0$ \textbf{to} $2^j-1$}
          \State $G_{2^j-1 + ih} \gets G_{2^j-1 + i h} G_{2^j-1 + ih + h/2}$
          \EndFor
      \EndFor
      \Return $G_0$
      \end{algorithmic}
      \end{algorithm}
\end{itemize}

\phantomsection

\bibliographystyle{plainnat}
\bibliography{deformation}

\end{document}
